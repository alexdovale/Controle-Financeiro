<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Painel Financeiro</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style> body { font-family: 'Inter', sans-serif; } </style>
</head>
<body class="bg-gray-900 text-white">
    <div id="loader" class="fixed inset-0 bg-gray-900 bg-opacity-80 flex items-center justify-center z-50">
        <p>Carregando...</p>
    </div>

    <div id="app-content" class="container mx-auto p-4 md:p-8 max-w-4xl hidden">
        <header class="flex flex-wrap justify-between items-center mb-8 gap-4">
            <div>
                <h1 class="text-3xl font-bold text-cyan-400">Painel Financeiro</h1>
                <p id="welcome-message" class="text-gray-400 mt-1"></p>
            </div>
            <div class="flex items-center gap-4">
                <a href="detalhes.html" class="bg-cyan-500 hover:bg-cyan-600 text-white font-bold py-2 px-4 rounded-lg transition-colors">Ver Detalhes</a>
                <button id="logout-btn" class="bg-red-500 hover:bg-red-600 text-white font-bold py-2 px-4 rounded-lg transition-colors">Sair</button>
            </div>
        </header>

        <section class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-8">
            <div class="bg-gray-800 p-6 rounded-xl shadow-lg"><h2 class="text-xl font-semibold text-gray-400 mb-2">Total de Receitas</h2><p id="total-receitas" class="text-4xl font-bold text-green-400">R$ 0,00</p></div>
            <div class="bg-gray-800 p-6 rounded-xl shadow-lg"><h2 class="text-xl font-semibold text-gray-400 mb-2">Total de Despesas</h2><p id="total-despesas" class="text-4xl font-bold text-red-400">R$ 0,00</p></div>
        </section>

        <section class="bg-gray-800 p-6 rounded-xl shadow-lg">
            <h2 class="text-2xl font-bold mb-4">Adicionar Nova Receita</h2>
            <form id="form-receita" class="flex flex-col md:flex-row gap-4 items-end">
                <div class="w-full"><label for="descricao-receita" class="block mb-2 text-sm font-medium text-gray-400">Descrição</label><input type="text" id="descricao-receita" class="bg-gray-700 border border-gray-600 text-white text-sm rounded-lg w-full p-2.5" placeholder="Ex: Salário" required></div>
                <div class="w-full md:w-1/3"><label for="valor-receita" class="block mb-2 text-sm font-medium text-gray-400">Valor (R$)</label><input type="number" id="valor-receita" step="0.01" class="bg-gray-700 border border-gray-600 text-white text-sm rounded-lg w-full p-2.5" placeholder="1500,00" required></div>
                <button type="submit" class="w-full md:w-auto bg-green-500 hover:bg-green-600 text-white font-bold py-2.5 px-6 rounded-lg">Adicionar</button>
            </form>
        </section>

        <section class="mt-8">
            <h2 class="text-2xl font-bold mb-4">Histórico de Receitas</h2>
            <div id="lista-receitas" class="space-y-3"></div>
        </section>
    </div>

    <!-- CONFIGURAÇÃO DO FIREBASE -->
    <script>
      const firebaseConfig = {
        apiKey: "AIzaSyAvUqbV2e0ewur3G7VQExREDuWbopb6pNU",
        authDomain: "financeiro-controle-35d72.firebaseapp.com",
        projectId: "financeiro-controle-35d72",
        storageBucket: "financeiro-controle-35d72.appspot.com",
        messagingSenderId: "587216584759",
        appId: "1:587216584759:web:036ed465f1b2b2439d3fb2",
        measurementId: "G-F1JCZNV7BX"
      };
    </script>
    
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
        import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
        import { getFirestore, collection, onSnapshot, addDoc, deleteDoc, doc, query } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        const loader = document.getElementById('loader');
        const appContent = document.getElementById('app-content');
        let currentUserId = null;

        onAuthStateChanged(auth, user => {
            if (user) {
                // Usuário está logado
                currentUserId = user.uid;
                document.getElementById('welcome-message').textContent = `Olá, ${user.email}!`;
                setupApp();
                loader.style.display = 'none';
                appContent.classList.remove('hidden');
            } else {
                // Usuário não está logado, redireciona
                window.location.href = 'login.html';
            }
        });
        
        const formatarMoeda = (valor) => valor.toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' });

        function setupApp() {
            const logoutBtn = document.getElementById('logout-btn');
            logoutBtn.addEventListener('click', () => {
                signOut(auth).catch(error => console.error("Erro ao sair:", error));
            });
            
            const formReceita = document.getElementById('form-receita');
            formReceita.addEventListener('submit', async (e) => {
                e.preventDefault();
                const descricao = document.getElementById('descricao-receita').value;
                const valor = parseFloat(document.getElementById('valor-receita').value);
                try {
                    await addDoc(collection(db, "users", currentUserId, "receitas"), { descricao, valor });
                    formReceita.reset();
                } catch (error) {
                    console.error("Erro ao adicionar receita:", error);
                }
            });

            // Escuta por mudanças em tempo real
            listenToData();
        }

        function listenToData() {
            // Referências das coleções
            const receitasRef = collection(db, "users", currentUserId, "receitas");
            const despesasGeraisRef = collection(db, "users", currentUserId, "despesasGerais");
            const cartoesRef = collection(db, "users", currentUserId, "cartoes");

            let allReceitas = [];
            let allDespesasGerais = [];
            let allCartoes = [];

            // Listener para receitas
            onSnapshot(query(receitasRef), snapshot => {
                allReceitas = snapshot.docs.map(d => ({ id: d.id, ...d.data() }));
                renderizarReceitas(allReceitas);
                calcularTotais();
            });
            // Listener para despesas gerais
            onSnapshot(query(despesasGeraisRef), snapshot => {
                allDespesasGerais = snapshot.docs.map(d => ({ id: d.id, ...d.data() }));
                calcularTotais();
            });
            // Listener para cartões (e suas despesas)
             onSnapshot(query(cartoesRef), snapshot => {
                const cartoesPromises = snapshot.docs.map(async cartaoDoc => {
                    const cartaoData = cartaoDoc.data();
                    const despesasCartaoRef = collection(db, "users", currentUserId, "cartoes", cartaoDoc.id, "despesas");
                    const despesasSnapshot = await new Promise(resolve => onSnapshot(query(despesasCartaoRef), resolve));
                    const despesas = despesasSnapshot.docs.map(d => d.data());
                    return { ...cartaoData, despesas };
                });

                Promise.all(cartoesPromises).then(cartoesCompletos => {
                    allCartoes = cartoesCompletos;
                    calcularTotais();
                });
            });

            function calcularTotais() {
                const totalReceitas = allReceitas.reduce((acc, r) => acc + r.valor, 0);
                const totalDespesasGerais = allDespesasGerais.reduce((acc, d) => acc + d.valor, 0);
                const totalDespesasCartoes = allCartoes.reduce((acc, cartao) => acc + cartao.despesas.reduce((s, d) => s + d.valor, 0), 0);
                
                document.getElementById('total-receitas').textContent = formatarMoeda(totalReceitas);
                document.getElementById('total-despesas').textContent = formatarMoeda(totalDespesasGerais + totalDespesasCartoes);
            }
        }
        
        function renderizarReceitas(receitas) {
            const listaEl = document.getElementById('lista-receitas');
            listaEl.innerHTML = '';
            if (receitas.length === 0) {
                listaEl.innerHTML = '<p class="text-gray-500">Nenhuma receita adicionada.</p>';
                return;
            }
            receitas.forEach(receita => {
                const div = document.createElement('div');
                div.className = 'bg-gray-800 p-4 rounded-lg flex justify-between items-center';
                div.innerHTML = `
                    <p class="font-semibold">${receita.descricao}</p>
                    <div class="text-right">
                        <p class="font-bold text-green-400">${formatarMoeda(receita.valor)}</p>
                        <button class="text-xs text-red-500 hover:text-red-400">Remover</button>
                    </div>`;
                div.querySelector('button').addEventListener('click', async () => {
                    await deleteDoc(doc(db, "users", currentUserId, "receitas", receita.id));
                });
                listaEl.appendChild(div);
            });
        }
    </script>
</body>
</html>

