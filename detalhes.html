<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Detalhes das Despesas</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style> 
        body { font-family: 'Inter', sans-serif; }
        .tab-content { display: none; }
        .tab-content.active { display: block; }
        .tab.active { border-color: #06b6d4; color: #06b6d4; }
    </style>
</head>
<body class="bg-gray-900 text-white">
    <div id="loader" class="fixed inset-0 bg-gray-900 bg-opacity-80 flex items-center justify-center z-50"><p>A carregar...</p></div>

    <div id="app-content" class="container mx-auto p-4 md:p-8 max-w-5xl hidden">
        <header class="flex flex-wrap justify-between items-center mb-8 gap-4">
            <div><h1 class="text-3xl font-bold text-cyan-400">Gerir Finanças</h1></div>
            <div class="flex items-center gap-4">
                <a href="index.html" class="bg-cyan-500 hover:bg-cyan-600 text-white font-bold py-2 px-4 rounded-lg">&larr; Voltar ao Painel</a>
                <button id="logout-btn" class="bg-red-500 hover:bg-red-600 text-white font-bold py-2 px-4 rounded-lg">Sair</button>
            </div>
        </header>

        <!-- Abas de Navegação -->
        <div class="mb-6 border-b border-gray-700">
            <nav class="flex space-x-8" aria-label="Tabs">
                <button class="tab active py-4 px-1 border-b-2 font-medium text-lg border-transparent text-gray-400 hover:text-gray-200 hover:border-gray-500" data-tab="despesas">Despesas do Mês</button>
                <button class="tab py-4 px-1 border-b-2 font-medium text-lg border-transparent text-gray-400 hover:text-gray-200 hover:border-gray-500" data-tab="cartoes">Cartões de Crédito</button>
                <button class="tab py-4 px-1 border-b-2 font-medium text-lg border-transparent text-gray-400 hover:text-gray-200 hover:border-gray-500" data-tab="emprestimos">Empréstimos</button>
            </nav>
        </div>

        <!-- Conteúdo das Abas -->
        <div id="despesas" class="tab-content active">
             <section class="bg-gray-800 p-6 rounded-xl shadow-lg mb-8">
                <h2 class="text-2xl font-bold mb-4">Adicionar Despesa</h2>
                <form id="form-despesa" class="grid grid-cols-1 md:grid-cols-5 gap-4 items-end mb-6">
                    <div class="md:col-span-2"><label for="descricao-despesa" class="block mb-2 text-sm text-gray-400">Descrição</label><input type="text" id="descricao-despesa" class="bg-gray-700 w-full p-2.5 rounded-lg" required></div>
                    <div><label for="valor-despesa" class="block mb-2 text-sm text-gray-400">Valor (R$)</label><input type="number" id="valor-despesa" step="0.01" class="bg-gray-700 w-full p-2.5 rounded-lg" required></div>
                    <div><label for="tipo-despesa" class="block mb-2 text-sm text-gray-400">Tipo</label><select id="tipo-despesa" class="bg-gray-700 w-full p-2.5 rounded-lg"><option value="variavel">Variável</option><option value="fixa">Fixa</option></select></div>
                    <button type="submit" class="bg-red-500 hover:bg-red-600 font-bold py-2.5 px-6 rounded-lg h-11">Adicionar</button>
                </form>
                <div id="lista-despesas" class="space-y-3"></div>
            </section>
        </div>

        <div id="cartoes" class="tab-content">
            <section class="bg-gray-800 p-6 rounded-xl shadow-lg mb-8">
                <h2 class="text-2xl font-bold mb-4">Adicionar Novo Cartão</h2>
                <form id="form-add-cartao" class="grid grid-cols-1 md:grid-cols-6 gap-4 items-end">
                    <div class="md:col-span-2"><label class="block text-sm mb-2">Nome</label><input type="text" id="nome-cartao" class="bg-gray-700 w-full p-2.5 rounded-lg" placeholder="Ex: Nubank UV" required></div>
                    <div><label class="block text-sm mb-2">Limite</label><input type="number" id="limite-cartao" class="bg-gray-700 w-full p-2.5 rounded-lg" placeholder="5000" required></div>
                    <div><label class="block text-sm mb-2">Dia Fecho</label><input type="number" id="fechamento-cartao" class="bg-gray-700 w-full p-2.5 rounded-lg" placeholder="20" required></div>
                    <div><label class="block text-sm mb-2">Dia Vencimento</label><input type="number" id="vencimento-cartao" class="bg-gray-700 w-full p-2.5 rounded-lg" placeholder="27" required></div>
                    <button type="submit" class="bg-cyan-500 hover:bg-cyan-600 font-bold py-2.5 px-6 rounded-lg h-11">Adicionar</button>
                </form>
            </section>
            <div id="container-cartoes" class="space-y-6"></div>
        </div>
        
        <div id="emprestimos" class="tab-content">
             <section class="bg-gray-800 p-6 rounded-xl shadow-lg mb-8">
                <h2 class="text-2xl font-bold mb-4">Adicionar Empréstimo ou Financiamento</h2>
                <form id="form-add-emprestimo" class="grid grid-cols-1 md:grid-cols-4 gap-4 items-end">
                    <div class="md:col-span-2"><label class="block text-sm mb-2">Descrição</label><input type="text" id="nome-emprestimo" class="bg-gray-700 w-full p-2.5 rounded-lg" placeholder="Financiamento Carro" required></div>
                    <div><label class="block text-sm mb-2">Valor Parcela</label><input type="number" id="valor-parcela-emprestimo" class="bg-gray-700 w-full p-2.5 rounded-lg" required></div>
                    <div><label class="block text-sm mb-2">Total de Parcelas</label><input type="number" id="total-parcelas-emprestimo" class="bg-gray-700 w-full p-2.5 rounded-lg" required></div>
                    <button type="submit" class="md:col-start-4 bg-cyan-500 hover:bg-cyan-600 font-bold py-2.5 px-6 rounded-lg h-11">Adicionar</button>
                </form>
            </section>
            <div id="container-emprestimos" class="space-y-6"></div>
        </div>

    </div>

    <!-- CONFIGURAÇÃO DO FIREBASE -->
    <script>
      const firebaseConfig = {
        apiKey: "AIzaSyAvUqbV2e0ewur3G7VQExREDuWbopb6pNU",
        authDomain: "financeiro-controle-35d72.firebaseapp.com",
        projectId: "financeiro-controle-35d72",
        storageBucket: "financeiro-controle-35d72.appspot.com",
        messagingSenderId: "587216584759",
        appId: "1:587216584759:web:036ed465f1b2b2439d3fb2",
        measurementId: "G-F1JCZNV7BX"
      };
    </script>
    
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
        import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
        import { getFirestore, collection, onSnapshot, addDoc, doc, query, deleteDoc } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        let currentUserId = null;
        const formatarMoeda = (valor) => (valor || 0).toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' });
        
        onAuthStateChanged(auth, user => {
            if (user) {
                currentUserId = user.uid;
                setupPage();
                document.getElementById('loader').style.display = 'none';
                document.getElementById('app-content').classList.remove('hidden');
            } else {
                window.location.href = 'login.html';
            }
        });

        function setupPage() {
            document.getElementById('logout-btn').addEventListener('click', () => signOut(auth));

            const tabs = document.querySelectorAll('.tab');
            tabs.forEach(tab => {
                tab.addEventListener('click', () => {
                    tabs.forEach(t => t.classList.remove('active'));
                    tab.classList.add('active');
                    
                    document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
                    document.getElementById(tab.dataset.tab).classList.add('active');
                });
            });

            // Lógica dos formulários
            const formDespesa = document.getElementById('form-despesa');
            formDespesa.addEventListener('submit', e => {
                e.preventDefault();
                const ref = collection(db, "users", currentUserId, "despesas");
                addDoc(ref, {
                    descricao: formDespesa['descricao-despesa'].value,
                    valor: parseFloat(formDespesa['valor-despesa'].value),
                    tipo: formDespesa['tipo-despesa'].value,
                    data: new Date()
                });
                formDespesa.reset();
            });

            const formCartao = document.getElementById('form-add-cartao');
            formCartao.addEventListener('submit', e => {
                 e.preventDefault();
                const ref = collection(db, "users", currentUserId, "cartoes");
                 addDoc(ref, {
                    nome: formCartao['nome-cartao'].value,
                    limite: parseFloat(formCartao['limite-cartao'].value),
                    diaFechamento: parseInt(formCartao['fechamento-cartao'].value),
                    diaVencimento: parseInt(formCartao['vencimento-cartao'].value),
                });
                formCartao.reset();
            });

            const formEmprestimo = document.getElementById('form-add-emprestimo');
            formEmprestimo.addEventListener('submit', e => {
                e.preventDefault();
                const ref = collection(db, "users", currentUserId, "emprestimos");
                addDoc(ref, {
                    nome: formEmprestimo['nome-emprestimo'].value,
                    valorParcela: parseFloat(formEmprestimo['valor-parcela-emprestimo'].value),
                    parcelasTotal: parseInt(formEmprestimo['total-parcelas-emprestimo'].value),
                    parcelasPagas: 0,
                    dataInicio: new Date()
                });
                formEmprestimo.reset();
            });
            
            // Listeners para os dados
            listenToDespesas();
            listenToCartoes();
            listenToEmprestimos();
        }

        function listenToDespesas() {
            const despesasRef = collection(db, "users", currentUserId, "despesas");
            onSnapshot(query(despesasRef), snapshot => {
                const despesas = snapshot.docs.map(d => ({id: d.id, ...d.data()}));
                const listaEl = document.getElementById('lista-despesas');
                listaEl.innerHTML = despesas.length ? '' : '<p class="text-gray-500">Nenhuma despesa registada.</p>';
                
                despesas.sort((a, b) => b.data.toMillis() - a.data.toMillis());
                despesas.forEach(despesa => {
                    const despesaEl = document.createElement('div');
                    despesaEl.className = 'flex justify-between items-center bg-gray-700 p-3 rounded-lg';
                    const tipoClasse = despesa.tipo === 'fixa' ? 'text-yellow-400' : 'text-blue-400';

                    despesaEl.innerHTML = `
                        <div>
                            <p class="font-semibold">${despesa.descricao}</p>
                            <p class="text-sm ${tipoClasse}">${despesa.tipo.charAt(0).toUpperCase() + despesa.tipo.slice(1)}</p>
                        </div>
                        <div class="text-right">
                           <p class="font-bold text-red-400">${formatarMoeda(despesa.valor)}</p>
                           <button data-id="${despesa.id}" class="text-xs text-gray-500 hover:text-red-400 js-delete-despesa">Excluir</button>
                        </div>
                    `;
                    listaEl.appendChild(despesaEl);
                    despesaEl.querySelector('.js-delete-despesa').addEventListener('click', () => {
                        deleteDoc(doc(db, "users", currentUserId, "despesas", despesa.id));
                    });
                });
            });
        }
        
        function listenToCartoes() {
            const cartoesRef = collection(db, "users", currentUserId, "cartoes");
            onSnapshot(query(cartoesRef), snapshot => {
                const containerEl = document.getElementById('container-cartoes');
                containerEl.innerHTML = '';
                snapshot.docs.forEach(cartaoDoc => {
                    const cartao = { id: cartaoDoc.id, ...cartaoDoc.data() };
                    const cartaoEl = document.createElement('div');
                    cartaoEl.className = 'bg-gray-800 p-6 rounded-xl shadow-lg';
                    cartaoEl.innerHTML = `
                        <div class="flex justify-between items-start mb-4">
                            <div>
                                <h3 class="text-2xl font-bold text-cyan-400">${cartao.nome}</h3>
                                <p class="text-sm text-gray-400">Fecha dia ${cartao.diaFechamento} | Vence dia ${cartao.diaVencimento}</p>
                            </div>
                            <button data-id="${cartao.id}" class="text-red-500 hover:text-red-400 text-sm js-delete-cartao">Excluir</button>
                        </div>

                        <div class="space-y-2 mb-4">
                            <div class="flex justify-between font-bold">
                                <span>Fatura Atual: <span id="fatura-total-${cartao.id}" class="text-red-400">${formatarMoeda(0)}</span></span>
                                <span>Disponível: <span id="limite-disponivel-${cartao.id}" class="text-green-400">${formatarMoeda(cartao.limite)}</span></span>
                            </div>
                            <div class="w-full bg-gray-700 rounded-full h-4">
                                <div id="limite-progress-${cartao.id}" class="bg-red-500 h-4 rounded-full" style="width: 0%;"></div>
                            </div>
                        </div>
                        
                        <div class="border-t border-gray-700 pt-4">
                             <h4 class="text-lg font-semibold mb-3">Lançar Compra</h4>
                             <form id="form-compra-${cartao.id}" class="grid grid-cols-1 md:grid-cols-4 gap-4 items-end">
                                <div class="md:col-span-2"><label class="block text-sm mb-1 text-gray-400">Descrição</label><input type="text" name="descricao" class="bg-gray-700 w-full p-2 rounded-lg" required></div>
                                <div><label class="block text-sm mb-1 text-gray-400">Valor Total</label><input type="number" step="0.01" name="valor" class="bg-gray-700 w-full p-2 rounded-lg" required></div>
                                <div><label class="block text-sm mb-1 text-gray-400">Parcelas</label><input type="number" name="parcelas" value="1" min="1" class="bg-gray-700 w-full p-2 rounded-lg" required></div>
                                <button type="submit" class="md:col-start-4 bg-cyan-500 hover:bg-cyan-600 font-bold py-2 px-4 rounded-lg h-10">Lançar</button>
                             </form>
                        </div>
                        
                        <div class="border-t border-gray-700 mt-6 pt-4">
                            <h4 class="text-lg font-semibold mb-3">Fatura Atual</h4>
                            <div id="fatura-detalhes-${cartao.id}" class="space-y-2">
                               <p class="text-gray-500">Nenhuma compra na fatura atual.</p>
                            </div>
                        </div>
                    `;
                    containerEl.appendChild(cartaoEl);

                    cartaoEl.querySelector('.js-delete-cartao').addEventListener('click', () => {
                        deleteDoc(doc(db, "users", currentUserId, "cartoes", cartao.id));
                    });

                    const formCompra = document.getElementById(`form-compra-${cartao.id}`);
                    formCompra.addEventListener('submit', e => {
                        e.preventDefault();
                        const comprasRef = collection(db, "users", currentUserId, "cartoes", cartao.id, "compras");
                        addDoc(comprasRef, {
                            descricao: formCompra.descricao.value,
                            valorTotal: parseFloat(formCompra.valor.value),
                            parcelasTotal: parseInt(formCompra.parcelas.value),
                            dataCompra: new Date()
                        });
                        formCompra.reset();
                    });
                    
                    listenToComprasDoCartao(cartao);
                });
            });
        }

        function listenToComprasDoCartao(cartao) {
            const comprasRef = collection(db, "users", currentUserId, "cartoes", cartao.id, "compras");
            onSnapshot(query(comprasRef), snapshot => {
                const compras = snapshot.docs.map(d => ({id: d.id, ...d.data()}));
                renderizarDetalhesCartao(cartao, compras);
            });
        }

        function listenToEmprestimos() {
            const emprestimosRef = collection(db, "users", currentUserId, "emprestimos");
            onSnapshot(query(emprestimosRef), snapshot => {
                const containerEl = document.getElementById('container-emprestimos');
                containerEl.innerHTML = snapshot.empty ? '<p class="text-gray-500 text-center">Nenhum empréstimo cadastrado.</p>' : '';
                snapshot.docs.forEach(doc => {
                    const emprestimo = { id: doc.id, ...doc.data() };
                    const percentualConcluido = (emprestimo.parcelasPagas / emprestimo.parcelasTotal) * 100;

                    const emprestimoEl = document.createElement('div');
                    emprestimoEl.className = 'bg-gray-800 p-6 rounded-xl shadow-lg';
                    emprestimoEl.innerHTML = `
                        <div class="flex justify-between items-start mb-4">
                            <div>
                                <h3 class="text-xl font-bold">${emprestimo.nome}</h3>
                                <p class="text-cyan-400 font-semibold">${formatarMoeda(emprestimo.valorParcela)} / mês</p>
                            </div>
                            <button data-id="${emprestimo.id}" class="text-red-500 hover:text-red-400 text-sm js-delete-emprestimo">Excluir</button>
                        </div>
                        <div>
                            <div class="flex justify-between text-sm text-gray-400 mb-1">
                                <span>Progresso</span>
                                <span>${emprestimo.parcelasPagas} / ${emprestimo.parcelasTotal} parcelas</span>
                            </div>
                            <div class="w-full bg-gray-700 rounded-full h-3">
                                <div class="bg-green-500 h-3 rounded-full" style="width: ${percentualConcluido}%;"></div>
                            </div>
                        </div>
                    `;
                    containerEl.appendChild(emprestimoEl);
                    emprestimoEl.querySelector('.js-delete-emprestimo').addEventListener('click', () => {
                        deleteDoc(doc(db, "users", currentUserId, "emprestimos", emprestimo.id));
                    });
                });
            });
        }

        function renderizarDetalhesCartao(cartao, compras) {
            const hoje = new Date();
            const mesAtual = hoje.getMonth();
            const anoAtual = hoje.getFullYear();

            let totalFaturaAtual = 0;
            let totalGasto = 0;
            const detalhesFaturaEl = document.getElementById(`fatura-detalhes-${cartao.id}`);
            detalhesFaturaEl.innerHTML = '';

            compras.forEach(compra => {
                const dataCompra = compra.dataCompra.toDate();
                const valorParcela = compra.valorTotal / compra.parcelasTotal;
                
                for (let i = 0; i < compra.parcelasTotal; i++) {
                    let mesVencimentoParcela = dataCompra.getMonth();
                    let anoVencimentoParcela = dataCompra.getFullYear();

                    if(dataCompra.getDate() > cartao.diaFechamento) {
                       mesVencimentoParcela += 1;
                    }
                    mesVencimentoParcela += i;

                    while(mesVencimentoParcela > 11) {
                        mesVencimentoParcela -= 12;
                        anoVencimentoParcela += 1;
                    }
                    
                    if (mesVencimentoParcela === mesAtual && anoVencimentoParcela === anoAtual) {
                        totalFaturaAtual += valorParcela;
                        const itemCompraEl = document.createElement('div');
                        itemCompraEl.className = 'flex justify-between items-center bg-gray-700 p-2 rounded';
                        itemCompraEl.innerHTML = `
                           <span>${compra.descricao} ${compra.parcelasTotal > 1 ? `(${i + 1}/${compra.parcelasTotal})` : ''}</span>
                           <span class="font-semibold">${formatarMoeda(valorParcela)}</span>
                        `;
                        detalhesFaturaEl.appendChild(itemCompraEl);
                    }
                    
                    const dataVencimentoFaturaParcela = new Date(anoVencimentoParcela, mesVencimentoParcela, cartao.diaVencimento);
                     if(dataVencimentoFaturaParcela >= hoje || (dataVencimentoFaturaParcela.getMonth() === mesAtual && dataVencimentoFaturaParcela.getFullYear() === anoAtual) ) {
                        totalGasto += valorParcela;
                    }
                }
            });

            if(detalhesFaturaEl.innerHTML === '') {
                 detalhesFaturaEl.innerHTML = '<p class="text-gray-500">Nenhuma compra na fatura atual.</p>';
            }
            
            const limiteDisponivel = cartao.limite - totalGasto;
            const percentualUso = (totalGasto / cartao.limite) * 100;

            document.getElementById(`fatura-total-${cartao.id}`).textContent = formatarMoeda(totalFaturaAtual);
            document.getElementById(`limite-disponivel-${cartao.id}`).textContent = formatarMoeda(limiteDisponivel);
            document.getElementById(`limite-progress-${cartao.id}`).style.width = `${Math.min(percentualUso, 100)}%`;
        }

    </script>
</body>
</html>

