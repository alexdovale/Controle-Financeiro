<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Detalhes das Despesas</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style> body { font-family: 'Inter', sans-serif; } .card-expense-form { display: none; } </style>
</head>
<body class="bg-gray-900 text-white">
    <div id="loader" class="fixed inset-0 bg-gray-900 bg-opacity-80 flex items-center justify-center z-50"><p>Carregando...</p></div>

    <div id="app-content" class="container mx-auto p-4 md:p-8 max-w-4xl hidden">
        <header class="flex flex-wrap justify-between items-center mb-8 gap-4">
            <div><h1 class="text-3xl font-bold text-cyan-400">Detalhes de Despesas</h1><p id="welcome-message" class="text-gray-400 mt-1"></p></div>
            <div class="flex items-center gap-4">
                <a href="index.html" class="bg-cyan-500 hover:bg-cyan-600 text-white font-bold py-2 px-4 rounded-lg">&larr; Voltar ao Painel</a>
                <button id="logout-btn" class="bg-red-500 hover:bg-red-600 text-white font-bold py-2 px-4 rounded-lg">Sair</button>
            </div>
        </header>

        <section class="bg-gray-800 p-6 rounded-xl shadow-lg mb-8">
            <h2 class="text-2xl font-bold mb-4">Despesas Gerais</h2>
            <form id="form-despesa-geral" class="flex flex-col md:flex-row gap-4 items-end mb-6">
                <div class="w-full"><label for="descricao-geral" class="block mb-2 text-sm text-gray-400">Descrição</label><input type="text" id="descricao-geral" class="bg-gray-700 border border-gray-600 text-white text-sm rounded-lg w-full p-2.5" placeholder="Ex: Almoço" required></div>
                <div class="w-full md:w-1/3"><label for="valor-geral" class="block mb-2 text-sm text-gray-400">Valor (R$)</label><input type="number" id="valor-geral" step="0.01" class="bg-gray-700 border border-gray-600 text-white text-sm rounded-lg w-full p-2.5" placeholder="50,00" required></div>
                <button type="submit" class="w-full md:w-auto bg-red-500 hover:bg-red-600 text-white font-bold py-2.5 px-6 rounded-lg">Adicionar</button>
            </form>
            <div id="lista-despesas-gerais" class="space-y-3"></div>
        </section>

        <section>
            <h2 class="text-2xl font-bold mb-4">Cartões de Crédito</h2>
             <div class="bg-gray-800 p-6 rounded-xl shadow-lg mb-6">
                <form id="form-add-cartao" class="flex flex-col md:flex-row gap-4">
                    <input type="text" id="nome-cartao" class="bg-gray-700 border border-gray-600 text-white text-sm rounded-lg w-full p-2.5" placeholder="Nome do Cartão (Ex: Nubank)" required>
                    <button type="submit" class="w-full md:w-auto bg-cyan-500 hover:bg-cyan-600 text-white font-bold py-2.5 px-6 rounded-lg">Adicionar Cartão</button>
                </form>
            </div>
            <div id="container-cartoes" class="space-y-6"></div>
        </section>
    </div>

    <!-- CONFIGURAÇÃO DO FIREBASE -->
    <script>
      const firebaseConfig = {
        apiKey: "AIzaSyAvUqbV2e0ewur3G7VQExREDuWbopb6pNU",
        authDomain: "financeiro-controle-35d72.firebaseapp.com",
        projectId: "financeiro-controle-35d72",
        storageBucket: "financeiro-controle-35d72.appspot.com",
        messagingSenderId: "587216584759",
        appId: "1:587216584759:web:036ed465f1b2b2439d3fb2",
        measurementId: "G-F1JCZNV7BX"
      };
    </script>
    
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
        import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
        import { getFirestore, collection, onSnapshot, addDoc, deleteDoc, doc, query, getDocs } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        const loader = document.getElementById('loader');
        const appContent = document.getElementById('app-content');
        let currentUserId = null;
        
        const formatarMoeda = (valor) => valor.toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' });

        onAuthStateChanged(auth, user => {
            if (user) {
                currentUserId = user.uid;
                document.getElementById('welcome-message').textContent = `Olá, ${user.email}!`;
                setupListeners();
                setupForms();
                loader.style.display = 'none';
                appContent.classList.remove('hidden');
            } else {
                window.location.href = 'login.html';
            }
        });

        function setupForms() {
            document.getElementById('logout-btn').addEventListener('click', () => signOut(auth));
            
            document.getElementById('form-despesa-geral').addEventListener('submit', async e => {
                e.preventDefault();
                const form = e.target;
                const ref = collection(db, "users", currentUserId, "despesasGerais");
                await addDoc(ref, {
                    descricao: form['descricao-geral'].value,
                    valor: parseFloat(form['valor-geral'].value)
                });
                form.reset();
            });

            document.getElementById('form-add-cartao').addEventListener('submit', async e => {
                e.preventDefault();
                const form = e.target;
                const ref = collection(db, "users", currentUserId, "cartoes");
                await addDoc(ref, { nome: form['nome-cartao'].value });
                form.reset();
            });
        }

        function setupListeners() {
            // Despesas Gerais
            onSnapshot(query(collection(db, "users", currentUserId, "despesasGerais")), snapshot => {
                const despesas = snapshot.docs.map(d => ({ id: d.id, ...d.data() }));
                renderDespesasGerais(despesas);
            });
            // Cartões
            onSnapshot(query(collection(db, "users", currentUserId, "cartoes")), snapshot => {
                renderCartoes(snapshot.docs);
            });
        }

        function renderDespesasGerais(despesas) {
            const listaEl = document.getElementById('lista-despesas-gerais');
            listaEl.innerHTML = despesas.length === 0 ? '<p class="text-gray-500">Nenhuma despesa geral.</p>' : '';
            despesas.forEach(d => {
                const div = document.createElement('div');
                div.className = 'bg-gray-700 p-3 rounded-lg flex justify-between items-center';
                div.innerHTML = `<span>${d.descricao}</span><div><span class="font-bold text-red-400">${formatarMoeda(d.valor)}</span><button class="ml-4 text-gray-500 hover:text-red-400 text-sm">X</button></div>`;
                div.querySelector('button').addEventListener('click', () => deleteDoc(doc(db, "users", currentUserId, "despesasGerais", d.id)));
                listaEl.appendChild(div);
            });
        }

        async function renderCartoes(cartoesDocs) {
            const containerEl = document.getElementById('container-cartoes');
            containerEl.innerHTML = '';
            for (const cartaoDoc of cartoesDocs) {
                const cartao = { id: cartaoDoc.id, ...cartaoDoc.data() };
                const despesasRef = collection(db, "users", currentUserId, "cartoes", cartao.id, "despesas");
                
                const secaoCartao = document.createElement('div');
                secaoCartao.className = 'bg-gray-800 p-6 rounded-xl shadow-lg';
                secaoCartao.innerHTML = `
                    <div class="flex justify-between items-center mb-4">
                        <div><h3 class="text-xl font-bold">${cartao.nome}</h3><p class="text-sm text-gray-400">Total: <span class="font-bold text-red-400" id="total-cartao-${cartao.id}"></span></p></div>
                        <div><button class="add-despesa-btn bg-cyan-700 hover:bg-cyan-800 text-xs font-bold py-1 px-3 rounded-md mr-2">+</button><button class="remove-cartao-btn bg-red-800 hover:bg-red-700 text-xs font-bold py-1 px-3 rounded-md">Remover</button></div>
                    </div>
                    <form class="mb-4 card-expense-form"><div class="flex flex-col md:flex-row gap-4 items-end"><div class="w-full"><input type="text" name="descricao" class="bg-gray-700 border border-gray-600 text-sm rounded-lg w-full p-2" placeholder="Descrição" required></div><div class="w-full md:w-1/4"><input type="number" name="valor" step="0.01" class="bg-gray-700 border border-gray-600 text-sm rounded-lg w-full p-2" placeholder="Valor" required></div><button type="submit" class="w-full md:w-auto bg-red-500 hover:bg-red-600 font-bold py-2 px-5 rounded-lg text-sm">Adicionar</button></div></form>
                    <div class="lista-despesas space-y-2"></div>`;
                
                // Eventos dos botões do cartão
                secaoCartao.querySelector('.remove-cartao-btn').addEventListener('click', () => deleteDoc(doc(db, "users", currentUserId, "cartoes", cartao.id)));
                const formDespesa = secaoCartao.querySelector('form');
                secaoCartao.querySelector('.add-despesa-btn').addEventListener('click', () => formDespesa.style.display = formDespesa.style.display === 'block' ? 'none' : 'block');
                formDespesa.addEventListener('submit', async e => {
                    e.preventDefault();
                    await addDoc(despesasRef, { descricao: e.target.descricao.value, valor: parseFloat(e.target.valor.value) });
                    e.target.reset();
                });

                // Listener para despesas do cartão
                onSnapshot(query(despesasRef), despesasSnapshot => {
                    const despesas = despesasSnapshot.docs.map(d => ({ id: d.id, ...d.data() }));
                    const total = despesas.reduce((acc, d) => acc + d.valor, 0);
                    secaoCartao.querySelector(`#total-cartao-${cartao.id}`).textContent = formatarMoeda(total);
                    const listaDespesasEl = secaoCartao.querySelector('.lista-despesas');
                    listaDespesasEl.innerHTML = despesas.length === 0 ? '<p class="text-gray-500 text-sm">Nenhuma despesa neste cartão.</p>' : '';
                    despesas.forEach(d => {
                        const div = document.createElement('div');
                        div.className = 'bg-gray-700 p-2 rounded-md flex justify-between items-center text-sm';
                        div.innerHTML = `<span>${d.descricao}</span><div><span class="font-semibold">${formatarMoeda(d.valor)}</span><button class="ml-3 text-gray-500 hover:text-red-400 text-xs">X</button></div>`;
                        div.querySelector('button').addEventListener('click', () => deleteDoc(doc(despesasRef, d.id)));
                        listaDespesasEl.appendChild(div);
                    });
                });
                
                containerEl.appendChild(secaoCartao);
            }
        }
    </script>

</body>
</html>

